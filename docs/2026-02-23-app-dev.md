# vibe-local アプリ開発編

> 窓の杜ブログ用記録 | 2026-02-23
> 環境: Windows 11 / RTX 4050 Laptop (VRAM 4GB) / RAM 32GB
> モデル: qwen3:8b（メイン）/ qwen3:1.7b（サイドカー）
> エンジン: vibe-coder.py v0.9.4（直接実行、プロキシ不要）

---

## はじめに

セットアップ編で Windows 上に vibe-local 環境を構築できた。ベンチマーク編ではプロキシ経由で基本的な応答テストを行った。

ここでは **vibe-coder.py を直接使って実際にアプリを生成** する実験を行う。プロキシも Claude Code CLI も不要 — Python + Ollama だけで動く Windows ネイティブ構成だ。

## 実験環境

| 項目 | 値 |
|------|-----|
| 実行方法 | `vibe-coder.py --model qwen3:8b -y -p "プロンプト"` |
| モード | ワンショット（`-p` でプロンプト指定）+ 自動承認（`-y`） |
| 出力先 | `playground/` ディレクトリ |
| 環境変数 | `PYTHONIOENCODING=utf-8`（必須 — cp932 では Unicode 罫線文字でクラッシュ） |

### 起動コマンド例

```bash
cd playground
PYTHONIOENCODING=utf-8 OLLAMA_HOST="http://localhost:11434" \
  VIBE_LOCAL_MODEL="qwen3:8b" VIBE_LOCAL_DEBUG="0" \
  timeout 120 python ../vibe-coder.py --model qwen3:8b -y \
  -p "Create a simple HTML file called janken.html..."
```

> **はかせ曰く:** 「Git Bash から `PYTHONIOENCODING=utf-8` を付けないと、バナーの罫線文字 `╦` で `UnicodeEncodeError: 'cp932'` が出て即死する。Windows あるある」

---

## 実験 1: じゃんけんゲーム（HTML）

**プロンプト:**
```
Create a simple HTML file called janken.html with a rock-paper-scissors game.
Japanese UI, buttons for グー/チョキ/パー, show result.
Inline CSS and JavaScript only, Meiryo font.
```

**結果:** 成功 — 42 行の HTML ファイルを生成

**生成されたファイル:** `playground/janken.html`

### 品質評価

| 項目 | 評価 | 詳細 |
|------|:----:|------|
| ファイル生成 | OK | 1回目の Write でファイルパスなしエラー → 2回目で成功 |
| HTML 構造 | OK | DOCTYPE、charset、title すべて正しい |
| CSS | OK | インライン CSS、Meiryo フォント指定 |
| JavaScript | OK | じゃんけんロジックが正確 |
| 日本語 UI | OK | ボタン（グー/チョキ/パー）、結果表示すべて日本語 |
| ブラウザ動作 | OK | そのまま開いて遊べる |

### コードの特徴

- `Math.random()` でコンピュータの手を選択
- 勝敗判定は `if-else` チェーンで正確に実装
- テンプレートリテラルで結果を表示
- **42 行で完結** — 無駄がない

> **はかせ曰く:** 「8b モデルでもじゃんけんくらいなら一発で正しいコードが出る。Claude に頼まなくてもこのレベルならローカルで十分」

---

## 実験 2: カウントダウンタイマー（HTML）

**プロンプト:**
```
Create a simple HTML file called timer.html.
Countdown timer app with Japanese UI.
Features: input minutes/seconds, start/pause/reset buttons,
large digital display, alert sound when zero.
Inline CSS and JavaScript only, Meiryo font.
```

**結果:** 成功 — 78 行の HTML ファイルを生成

**生成されたファイル:** `playground/timer.html`

### ツール使用の挙動

1. **1 回目の Write:** `file_path` パラメータなし → エラー
2. **2 回目の Write:** `timer.html` に書き込み → 成功
3. **3 回目の Write:** なぜか `C:\Users\Public\Documents\timer.html` にも書き込み（不要）

> **はかせ曰く:** 「パスを渡し忘れるのは qwen3:8b のツール使用あるある。リトライで直るけど、3回目の余分な書き込みは怖い。`-y`（自動承認）だから止められない」

### 品質評価

| 項目 | 評価 | 詳細 |
|------|:----:|------|
| ファイル生成 | OK | リトライ 1 回で成功 |
| タイマー機能 | OK | カウントダウン、一時停止、リセットが動作 |
| 大きなデジタル表示 | OK | `font-size: 120px` で見やすい |
| アラート音 | OK | Web Audio API で `880Hz` のビープ音（1秒間） |
| 日本語 UI | OK | 「スタート」「一時停止」「リセット」「分」「秒」 |
| バグ | 軽微 | 一時停止後にスタートすると入力値で再スタートする（残り時間からの再開ではない） |

### コードの特徴

- `setInterval` / `clearInterval` でタイマー制御
- `Web Audio API`（`OscillatorNode`）でアラート音 — 外部ファイル不要
- `padStart(2, '0')` で `00:00` 形式表示

> **はかせ曰く:** 「Web Audio API を使ってくるのは賢い。mp3 ファイルなしでアラート音が鳴る。ただし pause → start で残り時間がリセットされるバグあり。実用にはもう一声」

---

## 実験 3: マインスイーパー（HTML）

**プロンプト:**
```
Write a file at the absolute path D:/git.local/vibe-local/playground/minesweeper.html
containing a complete Minesweeper game.
9x9 grid, 10 mines, left click reveal, right click flag,
mine counter, timer, game over/win detection,
Japanese UI, Meiryo font, classic 3D borders.
```

**結果:** 3 回試行、3 回目で生成成功。ただし品質に問題あり。

### 試行の記録

| 試行 | 結果 | 詳細 |
|:----:|:----:|------|
| 1 回目 | NG | Write に `file_path` なし → エラー → `AskUserQuestion` で停止 |
| 2 回目 | NG | 同じパターンで失敗（プロンプトを変えても同じ） |
| 3 回目 | OK | 「コードを print して」→ echo でコード出力 → 別の Write で保存 |

> **はかせ曰く:** 「じゃんけんとタイマーは 1 回リトライで通ったのに、マインスイーパーは 2 回連続で完全に失敗した。コードの複雑さがツール使用の精度に影響するっぽい」

### 品質評価

| 項目 | 評価 | 詳細 |
|------|:----:|------|
| ファイル生成 | OK | 3 回目で成功 |
| HTML 構造 | NG | **全コードが 1 行に圧縮**（ミニファイ状態で可読性ゼロ） |
| CSS セレクタ | NG | `cell` と書くべきところが `.cell` でない（スタイル適用されない） |
| JavaScript | NG | `$revealCell` と `$` が混入（構文エラー） |
| ゲームロジック | NG | `board` データ構造が `find()` ベースで非効率、空セル展開なし |
| ブラウザ動作 | NG | 構文エラーで動作しない |

### 発見されたバグ一覧

1. **構文エラー:** `()=>$revealCell(cell)` — `$` が余分
2. **CSS セレクタ:** `cell { ... }` → `.cell { ... }` であるべき
3. **1 行圧縮:** `echo` コマンドで出力 → 改行なしの 1 行に
4. **データ構造:** `board.find(b => b.x == ...)` は O(n) 検索で非効率
5. **空セル展開なし:** 数字が 0 のセルをクリックしても隣接セルが自動展開されない
6. **mines 変数の二重使用:** 地雷配置後に `mines` が 0 になり、勝利判定が壊れる

> **はかせ曰く:** 「マインスイーパーは qwen3:8b には荷が重い。じゃんけん（42行）→ タイマー（78行）→ マインスイーパ（192行想定）と複雑さが上がるにつれてツール使用もコード品質もガタ落ちする。8b の限界が見えた」

---

## 総合まとめ

### 生成結果一覧

| アプリ | 行数 | 試行回数 | ツール使用 | コード品質 | 動作 |
|--------|:----:|:--------:|:----------:|:----------:|:----:|
| じゃんけん | 42 | 1（リトライ 1 回） | 部分的 OK | 良好 | 動作する |
| タイマー | 78 | 1（リトライ 1 回） | 部分的 OK | 良好（軽微バグ） | 動作する |
| マインスイーパ | 1（圧縮） | 3 | NG（2 回失敗） | 不良（構文エラー） | 動作しない |

### 発見と考察

#### qwen3:8b のツール使用能力

- **`file_path` パラメータを忘れる** のが最も頻繁なエラー（全 3 実験で発生）
- 単純なタスクではリトライで回復するが、複雑なタスクでは `AskUserQuestion` に逃げる
- `-y`（自動承認）モードでも意図しない場所にファイルを書き込むリスクがある

#### コード生成の品質

- **~50 行以下:** 正確で実用的なコードを生成できる
- **~80 行前後:** 動作するが軽微なバグが混入
- **~150 行以上:** 構文エラー、ロジック破綻、可読性崩壊

#### ローカル LLM アプリ開発の実用性

| ユースケース | 実用性 | 補足 |
|-------------|:------:|------|
| 簡単な 1 ファイル HTML アプリ | 実用的 | じゃんけん、電卓、単位変換など |
| 中程度の機能を持つアプリ | 条件付き | 手動でバグ修正が必要 |
| 複雑なゲームやアプリ | 非実用的 | 人間が書いた方が早い |
| プロトタイプ・叩き台 | 実用的 | 「ゼロから書かなくていい」価値 |

> **はかせ曰く:** 「ローカル 8b モデルで"プログラミングできた"と言えるのは、じゃんけんレベルまで。でも『完全オフラインで、ログインなしで、無料で、AI にコードを書かせる』体験としては十分インパクトがある。学校の授業で使うなら、このくらいがちょうどいいかも」

---

## 付録: vibe-coder.py のアーキテクチャメモ

vibe-coder.py は約 5,400 行の Python スクリプトで、以下の機能を内蔵:

- **REPL（対話モード）** と **ワンショットモード**（`-p` オプション）
- **ツール呼び出し:** Read / Write / Bash / Glob / Grep / WebSearch
- **Ollama API 直接通信:** `/api/chat` エンドポイントを使用
- **モデルティア自動判定:** パラメータ数に応じて Tier S/A/B/C を設定
- **コンテキスト管理:** トークン数を監視し、コンテキスト窓に収まるよう調整
- **バナー表示:** Vaporwave 風 ASCII アートバナー（←これが cp932 で死ぬ原因）

```
  ╦  ╦╦╔╗ ╔═╗  ╦  ╔═╗╔═╗╔═╗╦
  ╚╗╔╝║╠╩╗║╣   ║  ║ ║║  ╠═╣║
   ╚╝ ╩╚═╝╚═╝  ╩═╝╚═╝╚═╝╩ ╩╩═╝
```

> **はかせ曰く:** 「5,400 行のワンファイル Python。落合研にこういうの書ける人がいるの、すごい」

---

*次回予定: より大きなモデル（14b, 32b）での比較、または複数ファイルプロジェクト生成の実験*
